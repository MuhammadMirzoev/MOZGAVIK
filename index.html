<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–£—á–µ–±–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ AI</title>
<style>
  :root{ --bg:#f6f8fb; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --stroke:#e6eaf2; --dash:#d7dce6; --shadow:0 8px 24px rgba(15,23,42,.06); }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  [hidden]{display:none!important} /* <-- –∂—ë—Å—Ç–∫–æ –ø—Ä—è—á–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–∞–Ω–µ–ª–∏/–≤–∫–ª–∞–¥–∫–∏ */

  .wrap{max-width:1120px;margin:0 auto;padding:28px 16px 60px}
  .brand-mark{width:44px;height:44px;border-radius:12px;background:linear-gradient(180deg,#6f79ff,#6a4df5);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px;box-shadow:0 10px 30px rgba(52,87,255,.25);margin:12px auto 18px}
  .h1{font-size:40px;font-weight:800;text-align:center;margin:0 0 8px}
  .subtitle{text-align:center;color:#7b8497;font-size:16px;margin-bottom:34px}

  .upload-card{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:26px;width:760px;max-width:100%;margin:0 auto 28px}
  .upload-area{border:2px dashed var(--dash);border-radius:16px;padding:38px 18px;text-align:center;background:#fafbfe}
  .upload-icon{font-size:24px;color:#2b6bf3;margin-bottom:10px}
  .upload-title{font-size:18px;font-weight:600;margin-bottom:6px}
  .upload-hint{color:#8892a6;font-size:13px;margin-bottom:16px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px;border-radius:10px;border:0;cursor:pointer;background:#0b1324;color:#fff;font-weight:600;box-shadow:0 6px 16px rgba(11,19,36,.18)}
  .btn:hover{background:#1a2540}

  .panel{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:18px}
  .panel-title{font-weight:700;margin:4px 2px 14px;font-size:18px}
  .docs{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  @media (max-width:900px){.docs{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:560px){.docs{grid-template-columns:1fr}}
  .doc{background:#fbfcff;border:1px solid #eef2f7;border-radius:12px;padding:14px;display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center;cursor:pointer;transition:box-shadow .2s,border-color .2s}
  .doc:hover{box-shadow:0 8px 22px rgba(16,24,40,.06)}
  .doc-ico{width:40px;height:40px;border-radius:10px;background:#f1f4fb;display:flex;align-items:center;justify-content:center;color:#8b98b3;font-size:22px}
  .doc-name{font-weight:600;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .doc-meta{color:#8b96ac;font-size:12px}

  .topbar{display:flex;align-items:center;justify-content:space-between;margin:10px 0 12px}
  .two-cols{display:grid;grid-template-columns:1fr 430px;gap:22px}
  @media (max-width:1000px){.two-cols{grid-template-columns:1fr}}

  .card{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:16px}
  .card-title{font-weight:700;margin:2px 2px 12px}

  /* –†–∏–¥–µ—Ä */
  .reader{background:#eef2f6;border:1px solid var(--stroke);border-radius:16px;height:520px;display:flex;flex-direction:column;overflow:hidden}
  .reader-toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 12px;background:#f7f9fe;border-bottom:1px solid #e9eef6}
  .reader-body{flex:1;overflow:auto;padding:14px 16px;background:#fff}
  .reader-body h3{margin:0 0 10px}
  .muted{color:#6b7280}

  /* –ü—Ä–∞–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü */
  .tabs{display:flex;gap:8px;background:#f4f6fb;border-radius:12px;padding:6px;width:max-content;margin:0 6px 14px}
  .tab{font-weight:700;padding:8px 14px;border-radius:10px;color:#59657c;cursor:pointer;user-select:none}
  .tab.active{background:#fff;color:#0f172a;border:1px solid #e9edf5;box-shadow:0 3px 10px rgba(0,0,0,.04)}
  .list{display:flex;flex-direction:column;gap:10px}
  .item{background:#fff;border:1px solid #eef1f6;border-radius:12px;padding:14px;display:flex;gap:10px;align-items:flex-start;justify-content:space-between}
  .left{display:flex;gap:10px;align-items:flex-start}
  .dot-blue{width:8px;height:8px;border-radius:50%;background:#5a67f6;margin-top:7px}
  .badge{background:#f5f6ff;border:1px solid #e0e5ff;color:#6a73d7;font-size:12px;border-radius:10px;padding:6px 8px}

  /* GPT —á–∞—Ç ‚Äî –¢–û–õ–¨–ö–û –≤–Ω—É—Ç—Ä–∏ #tab-gpt */
  #tab-gpt .chat{display:flex;flex-direction:column;height:520px;background:#fff;border:1px solid #eef1f6;border-radius:16px;overflow:hidden}
  #tab-gpt .chat-body{flex:1;overflow:auto;padding:14px}
  #tab-gpt .msg{max-width:85%;margin:6px 0;padding:10px 12px;border-radius:12px;border:1px solid #e7ebf3;background:#f9fbff;white-space:pre-wrap}
  #tab-gpt .msg.me{margin-left:auto;background:#121a33;color:#fff;border-color:#121a33}
  #tab-gpt .chat-foot{display:flex;gap:8px;border-top:1px solid #eef1f6;padding:10px;background:#f7f9fe}
  #tab-gpt .inp{flex:1;padding:10px 12px;border:1px solid #e5e9f2;border-radius:10px;outline:none}
  #tab-gpt .sources{color:#6a73d7;font-size:12px;margin-top:6px}

  /* –í–∏–∑—É–∞–ª (–∏–≥—Ä–∞) */
  .viz-form{width:100%;max-width:920px;margin:0 auto;display:flex;flex-direction:column;gap:12px;background:#fff;border:1px solid #eef2f6;border-radius:16px;box-shadow:var(--shadow);padding:16px}
  .viz-row{display:flex;gap:10px;flex-wrap:wrap}
  .viz-chip{flex:1;display:flex;align-items:center;justify-content:space-between;gap:10px;background:#fbfcff;border:1px solid #eef2f6;border-radius:12px;padding:10px 12px}
  .viz-text{width:100%;min-height:160px;border:1px solid var(--stroke);border-radius:12px;padding:12px;background:#fff;resize:vertical}
  .viz-game{background:#fff;border:1px solid #eef2f6;border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
  .viz-toolbar{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid #eef2f6;background:#f7f9fe}
  .viz-frame{height:75vh;min-height:520px;position:relative}
  .viz-iframe{width:100%;height:100%;border:0}
  .viz-loader{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.6);backdrop-filter:blur(2px);font-weight:700;color:#0f172a}
  .viz-loader[hidden]{display:none}
  .viz-error{padding:10px;color:#7a1f1f;background:#fff5f5;border:1px solid #ffe0e0;border-radius:10px;margin-top:10px}
</style>
</head>
<body>

<!-- ===================== HOME ===================== -->
<section id="view-home" class="wrap">
  <div class="brand-mark">‚óªÔ∏é</div>
  <h1 class="h1">–£—á–µ–±–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ AI</h1>
  <p class="subtitle">3 –ø—Ä–∏–º–µ—Ä–∞ –∫–Ω–∏–≥ (–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞, –ò–ò, –ª–æ—Ä –∏–≥—Ä—ã) + –∑–∞–≥—Ä—É–∑–∫–∞ —Å–≤–æ–µ–π. –ß—Ç–µ–Ω–∏–µ, –ß–∞–Ω–∫–∏, –ö–æ–Ω—Å–ø–µ–∫—Ç, GPT –∏ –í–∏–∑—É–∞–ª (–∏–≥—Ä–∞)</p>

  <div class="upload-card">
    <div class="upload-area" id="upload-area">
      <div class="upload-icon">ü°Ö</div>
      <div class="upload-title">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</div>
      <div class="upload-hint">PDF / EPUB / FB2 / TXT</div>
      <input id="file-input" type="file" multiple hidden>
      <button class="btn" onclick="document.getElementById('file-input').click()">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
    </div>
  </div>

  <div class="panel">
    <div class="panel-title">–ù–µ–¥–∞–≤–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</div>
    <div id="docs" class="docs"></div>
  </div>
</section>

<!-- ===================== DOC ===================== -->
<section id="view-doc" class="wrap" hidden>
  <div class="topbar">
    <div style="display:flex;gap:10px;align-items:center">
      <div class="doc-ico">üìÑ</div>
      <div>
        <div class="doc-name" id="current-filename" style="font-size:16px">–î–æ–∫—É–º–µ–Ω—Ç</div>
        <div class="doc-meta" id="current-meta">‚Äî</div>
      </div>
    </div>
    <div style="display:flex;gap:10px">
      <a class="btn" href="#/home">üè† –î–æ–º–æ–π</a>
    </div>
  </div>

  <div class="two-cols">
    <!-- –õ–ï–í–ê–Ø: –†–∏–¥–µ—Ä -->
    <div class="card">
      <div class="card-title">üìñ –ß—Ç–µ–Ω–∏–µ</div>
      <div class="reader">
        <div class="reader-toolbar">
          <div>
            <button class="btn" id="prevPage">‚Üê</button>
            <button class="btn" id="nextPage">‚Üí</button>
          </div>
          <div class="muted">–°—Ç—Ä. <span id="pageNum">1</span> / <span id="pageTotal">1</span></div>
        </div>
        <div class="reader-body" id="readerBody"><h3>–û—Ç–∫—Ä–æ–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç</h3><div class="muted">–í—ã–±–µ—Ä–∏—Ç–µ –∫–Ω–∏–≥—É –Ω–∞ –≥–ª–∞–≤–Ω–æ–π</div></div>
      </div>
    </div>

    <!-- –ü–†–ê–í–ê–Ø: –≤–∫–ª–∞–¥–∫–∏ -->
    <div class="card">
      <div class="tabs">
        <div class="tab" data-tab="chunks">–ß–∞–Ω–∫–∏</div>
        <div class="tab" data-tab="conspect">–ö–æ–Ω—Å–ø–µ–∫—Ç</div>
        <div class="tab" data-tab="gpt">GPT</div>
        <div class="tab" data-tab="visual">–í–∏–∑—É–∞–ª</div>
      </div>

      <!-- –ß–∞–Ω–∫–∏ -->
      <div id="tab-chunks" class="list"></div>

      <!-- –ö–æ–Ω—Å–ø–µ–∫—Ç -->
      <div id="tab-conspect" class="list" hidden></div>

      <!-- GPT -->
      <div id="tab-gpt" hidden>
        <div class="chat">
          <div id="gptBody" class="chat-body"></div>
          <div class="chat-foot">
            <input id="gptInput" class="inp" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ –ø–æ —ç—Ç–æ–π –∫–Ω–∏–≥–µ‚Ä¶" />
            <button id="gptSend" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>
        </div>
      </div>

      <!-- –í–∏–∑—É–∞–ª: –ø–∞–Ω–µ–ª—å –∏ –∏–≥—Ä–∞ (–≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞–µ–º—ã–µ) -->
      <div id="tab-visual" hidden>
        <div id="viz-panel" class="viz-form">
          <textarea id="vizText" class="viz-text" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –æ—Ç—Ä—ã–≤–æ–∫ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–í–∑—è—Ç—å –∏–∑ 1-–π –≥–ª–∞–≤—ã¬ª"></textarea>
          <div class="viz-row">
            <label class="viz-chip"><span>–í–∞–π–±</span>
              <select id="vizVibe"><option>cinematic</option><option>arcade</option><option>cozy</option><option selected>neon</option><option>retro</option></select>
            </label>
            <label class="viz-chip"><span>–ü–∞–ª–∏—Ç—Ä–∞</span>
              <select id="vizPalette"><option selected>dark</option><option>light</option><option>paper</option><option>vapor</option></select>
            </label>
            <label class="viz-chip"><span>–¢–∏–ø</span>
              <select id="vizGameType"><option selected>quiz</option><option>dialog</option><option>novel</option><option>platformer</option><option>arcade</option><option>roguelike</option></select>
            </label>
          </div>
          <label class="viz-chip" style="flex:1;justify-content:space-between">
            <span>–°–ª–æ–∂–Ω–æ—Å—Ç—å</span><span id="vizDiffVal">60%</span>
            <input id="vizDifficulty" type="range" min="0" max="100" value="60" style="width:60%">
          </label>
          <div class="viz-row">
            <label class="viz-chip"><input id="vizLong" type="checkbox" checked> –î–ª–∏–Ω–Ω—ã–π –∫–æ–¥</label>
            <label class="viz-chip"><input id="vizAudio" type="checkbox"> –ó–≤—É–∫</label>
            <label class="viz-chip"><input id="vizProcedural" type="checkbox" checked> –ü—Ä–æ—Ü. –≥–µ–Ω–µ—Ä–∞—Ü–∏—è</label>
          </div>
          <div class="viz-row" style="justify-content:center">
            <button id="btnFromChapter" class="btn" type="button">üìë –í–∑—è—Ç—å –∏–∑ 1-–π –≥–ª–∞–≤—ã</button>
            <button id="vizRun" class="btn" type="button">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑</button>
          </div>
        </div>

        <div id="viz-game" class="viz-game" hidden>
          <div class="viz-toolbar">
            <button id="vizBack" class="btn">‚Üê –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º</button>
            <button id="vizDownload" class="btn">–°–∫–∞—á–∞—Ç—å game.html</button>
          </div>
          <div class="viz-frame">
            <div id="vizLoader" class="viz-loader" hidden>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–≥—Ä—ã‚Ä¶</div>
            <iframe id="vizFrame" class="viz-iframe" allowfullscreen></iframe>
          </div>
          <div id="vizErr" class="viz-error" hidden></div>
        </div>
      </div>

    </div>
  </div>
</section>

<script>
/* ===== helpers ===== */
function el(tag, cls, html){ const n=document.createElement(tag); if(cls) n.className=cls; if(html!==undefined) n.innerHTML=html; return n; }
function show(id){ document.querySelectorAll('section[id^="view-"]').forEach(v=>v.hidden=true); document.getElementById(id).hidden=false; }

/* ===== —Ä–æ—É—Ç–∏–Ω–≥ ===== */
function route(){
  const h = location.hash || '#/home';
  if(h.startsWith('#/home')){ show('view-home'); }
  else if(h.startsWith('#/doc/')){ show('view-doc'); const tab = h.split('/')[2] || 'chunks'; switchTab(tab); }
  else { location.hash='#/home'; }
}
window.addEventListener('hashchange', route); route();

/* ===== –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ===== */
window._current = { title:'', meta:'', pages:[], page:1, chapters:[], conspect:[] };
window._ui = { activeTab: 'chunks', vizBlobUrl: null, gptHistory: [] };

/* ===== –ù–µ–¥–∞–≤–Ω–∏–µ (samples) ===== */
async function loadSamples(){
  const box=document.getElementById('docs'); box.innerHTML='';
  try{
    const r = await fetch('/samples'); const d = await r.json();
    (d.items||[]).forEach(s=>{
      const card=el('div','doc');
      card.addEventListener('click', ()=> openSample(s));
      card.append(el('div','doc-ico','üìÑ'));
      const col=el('div','doc-col',''); col.append(el('div','doc-name',s.title)); col.append(el('div','doc-meta',`${s.size} ‚Ä¢ ${s.meta}`)); card.append(col);
      box.append(card);
    });
  }catch(e){
    box.innerHTML='<div class="doc-meta">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã</div>';
  }
}
loadSamples();

async function openSample(s){
  try{
    const j = await fetch(s.json_url).then(r=>r.json());
    setCurrentFromData(j);
  }catch(e){
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–º–µ—Ä: '+e.message);
  }
}

/* ===== Upload ===== */
const input = document.getElementById('file-input');
const area  = document.getElementById('upload-area');
const hint  = document.querySelector('.upload-hint');
function setHint(h){ if(hint) hint.innerHTML = h; }
input.addEventListener('change', e => { const f=e.target.files?.[0]; if(f) upload(f); e.target.value=''; });
['dragenter','dragover'].forEach(ev=> area.addEventListener(ev, e=>{ e.preventDefault(); area.style.background='#f2f6ff'; }));
['dragleave','drop'].forEach(ev=> area.addEventListener(ev, e=>{ e.preventDefault(); area.style.background='#fafbfe'; }));
area.addEventListener('drop', e=>{ const f=e.dataTransfer.files?.[0]; if(f) upload(f); });

async function upload(file){
  if(!/\.(pdf|epub|fb2|txt)$/i.test(file.name)){ alert('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è PDF/EPUB/FB2/TXT'); return; }
  const fd = new FormData(); fd.append('file', file);
  setHint('–ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ (2 —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞)‚Ä¶');
  try{
    const r = await fetch('/upload', { method:'POST', body: fd });
    const d = await r.json();
    if(!r.ok || !d.ok) throw new Error(d.error||d.details||'–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
    setHint(`–ì–æ—Ç–æ–≤–æ: <a class="link" href="${d.json_url}" target="_blank">data.json</a> ‚Ä¢ –≥–ª–∞–≤: ${d.chapters_count}`);
    const j = await fetch(d.json_url).then(r=>r.json());
    setCurrentFromData(j);
  }catch(err){
    alert('–û—à–∏–±–∫–∞: '+err.message); setHint('PDF / EPUB / FB2 / TXT');
  }
}

/* ===== UI –∏–∑ JSON ===== */
function setCurrentFromData(j){
  window._current.title = j.title||'–î–æ–∫—É–º–µ–Ω—Ç';
  window._current.meta  = j.meta||'';
  window._current.pages = j.pages||[];
  window._current.page  = 1;
  window._current.chapters = j.chapters||[];
  window._current.conspect = j.conspect||[];

  document.getElementById('current-filename').textContent = window._current.title;
  document.getElementById('current-meta').textContent = window._current.meta;

  renderReader();

  // –æ—á–∏—Å—Ç–∫–∞ –≤–∫–ª–∞–¥–æ–∫
  cleanupTab('chunks'); cleanupTab('conspect'); cleanupTab('gpt'); resetVisualUI();
  window._ui.gptHistory = []; // –Ω–æ–≤–∞—è –∫–Ω–∏–≥–∞ ‚Äî –Ω–æ–≤–∞—è –∏—Å—Ç–æ—Ä–∏—è
  location.hash='#/doc/chunks';
}

/* ===== Reader ===== */
function renderReader(){
  const body=document.getElementById('readerBody');
  const pageEl=document.getElementById('pageNum');
  const totEl=document.getElementById('pageTotal');
  const pages=window._current.pages||[];
  const page=Math.max(1, Math.min(pages.length||1, window._current.page||1));
  window._current.page = page;
  pageEl.textContent = String(page);
  totEl.textContent = String(pages.length||1);
  body.innerHTML = `<h3>${window._current.title}</h3><div>${(pages[page-1]||'').replace(/\n/g,'<br>')}</div>`;
}
document.getElementById('prevPage').addEventListener('click', ()=>{ window._current.page=Math.max(1,(window._current.page||1)-1); renderReader(); });
document.getElementById('nextPage').addEventListener('click', ()=>{ const t=(window._current.pages||[]).length||1; window._current.page=Math.min(t,(window._current.page||1)+1); renderReader(); });

/* ===== –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ ===== */
function switchTab(name){
  ['chunks','conspect','gpt','visual'].forEach(n=>{
    const el = document.getElementById('tab-'+n);
    if(el) el.hidden = (n !== name);
  });
  document.querySelectorAll('#view-doc .tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name));
  const prev = window._ui.activeTab;
  if(prev && prev !== name) cleanupTab(prev);
  window._ui.activeTab = name;
  if(name === 'chunks')   renderChunks();
  if(name === 'conspect') renderConspect();
  if(name === 'gpt')      renderGPT();
  if(name === 'visual')   bindVisualHandlers();
}

function cleanupTab(name){
  if(name === 'visual'){ resetVisualUI(); return; }
  if(name === 'gpt'){
    // –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å —á–∞—Ç–∞ (DOM + –∏—Å—Ç–æ—Ä–∏—è + –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏)
    const body  = document.getElementById('gptBody');
    const input = document.getElementById('gptInput');
    const send  = document.getElementById('gptSend');
    window._ui.gptHistory = [];
    if(body)  body.innerHTML='';
    if(input){ input.value=''; input.disabled=false; input.onkeydown=null; input.removeAttribute('data-bound'); }
    if(send){ send.disabled=false; send.onclick=null; send.removeAttribute('data-bound'); }
    return;
  }
  const box = document.getElementById('tab-'+name);
  if(box) box.innerHTML = '';
}

/* ===== –†–µ–Ω–¥–µ—Ä: –ß–∞–Ω–∫–∏ / –ö–æ–Ω—Å–ø–µ–∫—Ç ===== */
function renderChunks(){
  const box=document.getElementById('tab-chunks'); box.innerHTML='';
  (window._current.chapters||[]).forEach(c=>{
    const it=el('div','item');
    const left=el('div','left'); left.append(el('div','dot-blue'));
    const txt=el('div',''); txt.append(el('h4','', c.title||'(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'));
    const sn=(c.text||'').trim().slice(0,400)+(((c.text||'').length>400)?'‚Ä¶':'');
    txt.append(el('p','', sn)); left.append(txt); it.append(left);
    it.append(el('span','badge','–≥–ª–∞–≤–∞'));
    box.append(it);
  });
}
function renderConspect(){
  const box=document.getElementById('tab-conspect'); box.innerHTML='';
  const list = window._current.conspect||[];
  if(!list.length){ box.append(el('div','muted','–î–ª—è —ç—Ç–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∫–æ–Ω—Å–ø–µ–∫—Ç –Ω–µ –∑–∞–¥–∞–Ω.')); return; }
  list.forEach(p=>{
    const it=el('div','item');
    const left=el('div','left'); left.append(el('div','dot-blue'));
    const txt=el('div',''); txt.append(el('p','', p));
    left.append(txt); it.append(left);
    box.append(it);
  });
}

/* ===== GPT —á–∞—Ç (—Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –≤ #tab-gpt) ===== */
function renderGPT(){
  const body = document.getElementById('gptBody');
  const input = document.getElementById('gptInput');
  const send  = document.getElementById('gptSend');
  window._ui.gptHistory = [];

  if(body){
    body.innerHTML='';
    const hello = document.createElement('div');
    hello.className='msg';
    hello.textContent = `–°–ø—Ä–æ—Å–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –ø–æ –∫–Ω–∏–≥–µ ¬´${window._current.title||'–¥–æ–∫—É–º–µ–Ω—Ç'}¬ª. –û—Ç–≤–µ—á–∞—é —Ç–æ–ª—å–∫–æ –ø–æ –µ—ë —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é.`;
    body.append(hello);
  }

  async function askBackend(question){
    input.disabled = true; send.disabled = true;
    try{
      const payload = {
        question,
        history: window._ui.gptHistory,
        doc: { title: window._current.title, chapters: window._current.chapters, pages: window._current.pages }
      };
      const r = await fetch('/chat', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      const raw = await r.text(); let d=null; try{ d=raw?JSON.parse(raw):null }catch{}
      if(!r.ok || !d || !d.answer){
        pushAssistant((d&&(d.error||d.details))||'–û—à–∏–±–∫–∞.');
      } else {
        pushAssistant(d.answer, d.used||[]);
      }
    }catch(e){
      pushAssistant('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: '+e.message);
    }finally{
      input.disabled = false; send.disabled = false; input.focus();
    }
  }

  function msg(role, text){
    const m=document.createElement('div'); m.className='msg'+(role==='user'?' me':''); m.textContent=text; return m;
  }
  function pushUser(text){
    body.append(msg('user', text));
    window._ui.gptHistory.push({role:'user', content:text});
    body.scrollTop = body.scrollHeight;
  }
  function pushAssistant(text, used){
    const wrap=document.createElement('div');
    wrap.append(msg('assistant', text));
    if(used && used.length){
      const s=document.createElement('div'); s.className='sources'; s.textContent='–§—Ä–∞–≥–º–µ–Ω—Ç—ã: '+used.join(' ‚Ä¢ ');
      wrap.append(s);
    }
    body.append(wrap);
    window._ui.gptHistory.push({role:'assistant', content:text});
    body.scrollTop = body.scrollHeight;
  }

  function onSend(){
    const q=(input.value||'').trim();
    if(!q) return;
    input.value='';
    pushUser(q);
    askBackend(q);
  }

  // –ø—Ä–∏–≤—è–∑–∫–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
  if(!send.dataset.bound){ send.dataset.bound='1'; send.onclick=onSend; }
  if(!input.dataset.bound){ input.dataset.bound='1'; input.onkeydown=(e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); onSend(); } }; }
}

/* ===== –í–∏–∑—É–∞–ª: –∏–≥—Ä–∞ –≤–º–µ—Å—Ç–æ –ø–∞–Ω–µ–ª–∏ ===== */
function bindVisualHandlers(){
  const diff=document.getElementById('vizDifficulty');
  if(diff && !diff.dataset.bound){ diff.dataset.bound='1'; diff.addEventListener('input', e=> document.getElementById('vizDiffVal').textContent=e.target.value+'%'); }
  const from=document.getElementById('btnFromChapter');
  if(from && !from.dataset.bound){ from.dataset.bound='1'; from.addEventListener('click', ()=>{ const first=(window._current.chapters||[])[0]?.text||''; document.getElementById('vizText').value=first.slice(0,5000); }); }
  const run=document.getElementById('vizRun');
  if(run && !run.dataset.bound){ run.dataset.bound='1'; run.addEventListener('click', startVisualGame); }
  const back=document.getElementById('vizBack');
  if(back && !back.dataset.bound){ back.dataset.bound='1'; back.addEventListener('click', ()=> switchVisual('panel')); }
  const dl=document.getElementById('vizDownload');
  if(dl && !dl.dataset.bound){ dl.dataset.bound='1'; dl.addEventListener('click', downloadGame); }
  switchVisual('panel'); // –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –≤–∫–ª–∞–¥–∫—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
}

function resetVisualUI(){
  const panel = document.getElementById('viz-panel');
  const game  = document.getElementById('viz-game');
  if(panel) panel.hidden = false;
  if(game)  game.hidden  = true;

  const frame=document.getElementById('vizFrame');
  if(frame){
    if(window._ui.vizBlobUrl){ URL.revokeObjectURL(window._ui.vizBlobUrl); window._ui.vizBlobUrl=null; }
    frame.removeAttribute('src'); frame.dataset.html='';
  }
  const err=document.getElementById('vizErr'); const loader=document.getElementById('vizLoader');
  if(err) err.hidden=true; if(loader) loader.hidden=true;
}

function switchVisual(to){
  if(to==='game'){
    document.getElementById('viz-panel').hidden = true;   // –ø—Ä—è—á–µ–º –∫–æ–Ω—Ñ–∏–≥
    document.getElementById('viz-game').hidden  = false;  // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä—É –ù–ê –ï–ì–û –ú–ï–°–¢–ï
  }else{ // –≤–µ—Ä–Ω—É—Ç—å –∫–æ–Ω—Ñ–∏–≥
    resetVisualUI();
  }
}

function downloadGame(){
  const frame=document.getElementById('vizFrame'); const html=frame?.dataset.html||'';
  if(!html){ alert('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∏–≥—Ä—É'); return; }
  const blob=new Blob([html],{type:'text/html'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='game.html'; a.click(); URL.revokeObjectURL(url);
}

async function startVisualGame(){
  const text=document.getElementById('vizText').value.trim();
  if(!text){ alert('–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç'); return; }
  switchVisual('game'); // —Å—Ä–∞–∑—É –∑–∞–º–µ–Ω—è–µ–º –ø–∞–Ω–µ–ª—å –Ω–∞ –∏–≥—Ä—É

  const loader=document.getElementById('vizLoader');
  const frame =document.getElementById('vizFrame');
  const err   =document.getElementById('vizErr');
  loader.hidden=false; err.hidden=true;

  const payload={
    text,
    vibe: document.getElementById('vizVibe').value,
    palette: document.getElementById('vizPalette').value,
    game_type: document.getElementById('vizGameType').value,
    difficulty: Number(document.getElementById('vizDifficulty').value),
    long_code: !!document.getElementById('vizLong').checked,
    audio: !!document.getElementById('vizAudio').checked,
    procedural: !!document.getElementById('vizProcedural').checked
  };

  try{
    const r = await fetch('/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const raw = await r.text(); let d=null; try{ d=raw?JSON.parse(raw):null }catch{}
    if(!r.ok || !d || !d.code){ err.textContent=(d&&(d.error||d.details))||raw||'–û—à–∏–±–∫–∞'; err.hidden=false; loader.hidden=true; return; }

    if(window._ui.vizBlobUrl){ URL.revokeObjectURL(window._ui.vizBlobUrl); window._ui.vizBlobUrl=null; }
    const html=d.code; const blob=new Blob([html],{type:'text/html'}); window._ui.vizBlobUrl=URL.createObjectURL(blob);
    frame.src=window._ui.vizBlobUrl; frame.dataset.html=html;

    frame.onload=()=>{ loader.hidden=true; try{
      const meta=frame.contentWindow&&frame.contentWindow.gameMeta;
      if(!meta){ err.textContent='–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: window.gameMeta –Ω–µ –Ω–∞–π–¥–µ–Ω'; err.hidden=false; }
    }catch(e){ err.textContent='–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å gameMeta: '+e; err.hidden=false; }};
  }catch(e){
    err.textContent='–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: '+e; err.hidden=false; loader.hidden=true;
  }
}

/* ===== –∫–ª–∏–∫–∏ –ø–æ —Ç–∞–±–∞–º ===== */
document.querySelectorAll('#view-doc .tab').forEach(t=>{ t.onclick = () => { location.hash = '#/doc/' + t.dataset.tab; }; });
</script>
</body>
</html>
